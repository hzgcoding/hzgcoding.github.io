<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="记录点滴"><title>linux fork函数详解 | Genge 随笔</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><meta name="generator" content="Hexo 4.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">linux fork函数详解</h1><a id="logo" href="/.">Genge 随笔</a><p class="description">好好学习 实现财富自由</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">linux fork函数详解</h1><div class="post-meta">Jan 23, 2020</div><div class="post-content"><h3 id="函数原型：-pid-t-fork-void"><a href="#函数原型：-pid-t-fork-void" class="headerlink" title="函数原型： pid_t    fork(void)"></a>函数原型： <code>pid_t    fork(void)</code></h3><ol>
<li>参数：不需要参数</li>
<li>需要的头文件<code>&lt;sys/types.h&gt;</code> 和 <code>&lt;unistd.h&gt;</code></li>
<li>返回值分两种情况：<ul>
<li>返回0表示成功创建子进程，并且接下来进入子进程执行流程</li>
<li>返回PID（&gt;0），成功创建子进程，并且继续执行父进程流程代码</li>
<li>返回非正数（&lt;0），创建子进程失败，失败原因主要有：<ul>
<li>进程数超过系统所能创建的上限，errno会被设置为EAGAIN</li>
<li>系统内存不足，errno会被设置为ENOMEM</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="地址空间"><a href="#地址空间" class="headerlink" title="地址空间"></a>地址空间</h3><blockquote>
<p>使用 fork() 函数得到的子进程是父进程的一个复制品，它从父进程处继承了整个进程的地址空间：包括进程上下文（进程执行活动全过程的静态描述）、进程堆栈、打开的文件描述符、信号控制设定、进程优先级、进程组号等。<strong>子进程所独有的只有它的进程号，计时器等（只有小量信息）</strong>。因此，使用 fork() 函数的代价是很大的。</p>
</blockquote>
<h3 id="共享方式"><a href="#共享方式" class="headerlink" title="共享方式"></a>共享方式</h3><blockquote>
<p>实际上，更准确来说，Linux 的 fork() 使用是通过<strong>写时拷贝</strong> (copy- on-write) 实现。写时拷贝是一种可以推迟甚至避免拷贝数据的技术。内核此时并不复制整个进程的地址空间，而是让父子进程共享同一个地址空间。只用在需要写入的时候才会复制地址空间，从而使各个进行拥有各自的地址空间。也就是说，资源的复制是在需要写入的时候才会进行，在此之前，只有以只读方式共享。 </p>
</blockquote>
<h3 id="执行顺序"><a href="#执行顺序" class="headerlink" title="执行顺序"></a>执行顺序</h3><blockquote>
<p> 创建新进程成功后，系统中出现两个基本完全相同的进程，这两个进程执行没有固定的先后顺序，哪个进程先执行要看系统的进程调度策略。</p>
</blockquote>
<blockquote>
<p>linux有个类似的函数vfork()：函数表面看起来都一样，但是它保证子进程先运行,在它调用 exec（进程替换） 或 exit（退出进程）之后父进程才可能被调度运行。子进程共享父进程的地址空间（准确来说，在调用 exec（进程替换） 或 exit（退出进程） 之前与父进程数据是共享的）， vfork() 创建的子进程会执行完后，才到父进程执行。</p>
</blockquote>
<h3 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h3><p>子进程与父进程的区别在于：</p>
<ol>
<li>除了文件锁以外,其他的锁都会被继承</li>
<li>各自的进程ID和父进程ID不同</li>
<li>子进程的未决告警被清除；</li>
<li>子进程的未决信号集设置为空集。</li>
</ol>
<h3 id="孤儿进程、僵尸进程"><a href="#孤儿进程、僵尸进程" class="headerlink" title="孤儿进程、僵尸进程"></a>孤儿进程、僵尸进程</h3><blockquote>
<p>fork系统调用之后，父子进程将交替执行，执行顺序不定。如果父进程先退出，子进程还没退出那么子进程的父进程将变为init进程（托孤给了init进程）。（注：任何一个进程都必须有父进程）如果子进程先退出，父进程还没退出，那么子进程必须等到父进程捕获到了子进程的退出状态才真正结束，否则这个时候子进程就成为僵进程（僵尸进程：只保留一些退出信息供父进程查询）</p>
</blockquote>
<h3 id="多线程进程的Fork调用"><a href="#多线程进程的Fork调用" class="headerlink" title="多线程进程的Fork调用"></a>多线程进程的Fork调用</h3><p>坑大，面试可能会问道，工作中也要小心使用<br><a href="https://blog.codingnow.com/2011/01/fork_multi_thread.html" target="_blank" rel="noopener">云风 BLOG: 极不和谐的 fork 多线程程序</a><br>讲的主要是当前的进程processA (thread a/b/c)的当前子线程thread a调用fork后，会创建子进程，但是只是复制了thread a，总结一句就是所有父进程中别的线程，到了子进程中都是突然蒸发掉的。这样会导致各种死锁问题，以及各种数据不一致等问题。最好的办法是在多线程进程里不是用fork。如果非使用不可，尽量fork完毕后直接exec，不调用任何其他除了fork之外的函数。exec可以覆盖内存空间，可以解决所有关于锁的问题。<br>还有一些文章可以看看：</p>
<ol>
<li><a href="https://blog.csdn.net/Move_now/article/details/73537535" target="_blank" rel="noopener">谨防fork与锁之间的深坑 - CSDN博客</a> </li>
<li><a href="https://blog.csdn.net/lyh__521/article/details/45921515" target="_blank" rel="noopener">子进程继承父进程中互斥锁的讨论 - CSDN博客</a>  </li>
<li><a href="https://blog.csdn.net/u011878172/article/details/79438584" target="_blank" rel="noopener">在多线程中使用fork函数导致死锁，以及解决方案 - CSDN博客</a></li>
</ol>
</div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2020/01/23/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E6%97%B6%E9%97%B4%E8%BD%AETimer%E5%AE%9A%E6%97%B6%E5%99%A8/">Timer 定时器技术分享</a><a class="next" href="/2020/01/23/%E5%85%A8%E5%B1%80%E5%94%AF%E4%B8%80ID%E7%94%9F%E6%88%90%E7%AE%97%E6%B3%95%E4%BC%98%E5%8C%96/">全局唯一ID生成算法优化</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="genge.cc"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/01/23/Linux%20shell%E8%AF%AD%E8%A8%80%E2%80%94%E2%80%94dash%E5%92%8Cbash/">Linux shell语言——dash和bash</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/23/%E5%8D%95%E7%94%9F%E4%BA%A7%E8%80%85%E5%8D%95%E6%B6%88%E8%B4%B9%E8%80%85%E7%8E%AF%E5%BD%A2%E7%BC%93%E5%86%B2/">单生产者单消费者环形缓冲</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/23/%E5%90%84%E7%B1%BBAPP%E6%8E%92%E8%A1%8C%E6%A6%9C%E5%AE%9E%E7%8E%B0/">各类APP排行榜实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/23/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E6%97%B6%E9%97%B4%E8%BD%AETimer%E5%AE%9A%E6%97%B6%E5%99%A8/">Timer 定时器技术分享</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/23/linux%20fork%E5%87%BD%E6%95%B0%E8%AF%A6%E8%A7%A3/">linux fork函数详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/23/%E5%85%A8%E5%B1%80%E5%94%AF%E4%B8%80ID%E7%94%9F%E6%88%90%E7%AE%97%E6%B3%95%E4%BC%98%E5%8C%96/">全局唯一ID生成算法优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/23/linux%20%E7%B3%BB%E7%BB%9F%E4%BF%A1%E5%8F%B7%E5%92%8C%E4%B8%AD%E6%96%AD%E5%B8%B8%E8%AF%86/">linux 系统信号和中断常识</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/23/linux%20%E5%AE%89%E8%A3%85%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%ACMySql/">linux 安装指定版本MySql</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/23/TCP%20%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B/">TCP 三次握手和四次挥手</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/23/%E7%BD%91%E6%98%93%E4%BA%92%E5%A8%B1%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93/">网易互娱面试总结</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.younfor.com/" title="字节跳动大神" target="_blank">字节跳动大神</a><ul></ul><a href="http://www.hl174.com/" title="百度大佬" target="_blank">百度大佬</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">Genge 随笔.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>